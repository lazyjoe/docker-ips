server {
    listen 80;
    server_name ipsforum.local dev.tnc.com;
    root /var/www/forum;
    charset utf-8;

    rewrite ^/(magazin|magazine)/category/sex-erotik/das-kaufmich-glossar/(.*)$ /community/v1Rewrite.php?id=1&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sex-erotik/sex-kolumne/(.*)$ /community/v1Rewrite.php?id=31&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sex-erotik/body-mind/(.*)$ /community/v1Rewrite.php?id=32&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sex-erotik/bdsm-fetisch/(.*)$ /community/v1Rewrite.php?id=34&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sex-erotik/(.*)$ /community/v1Rewrite.php?id=2&$2 permanent;
    rewrite ^/(magazin|magazine)/category/pornostars/(.*)$ /community/v1Rewrite.php?id=3&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/neuigkeiten/(.*)$ /community/v1Rewrite.php?id=4&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/erotische-sex-geschichten/(.*)$ /community/v1Rewrite.php?id=5&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/bdsm-fetisch/(.*)$ /community/v1Rewrite.php?id=6&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/wichtige-infos-fuer-escorts/informationen-fuer-kunden-und-escorts/(.*)$ /community/v1Rewrite.php?id=7&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/wichtige-infos-fuer-escorts/(.*)$ /community/v1Rewrite.php?id=8&$2 permanent;
    rewrite ^/(magazin|magazine)/category/rund-um-kaufmich/das-team/(.*)$ /community/v1Rewrite.php?id=9&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/wie-funktioniert-kaufmich/(.*)$ /community/v1Rewrite.php?id=10&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/page/2/(.*)$ /community/v1Rewrite.php?id=11&$2 permanent;
    rewrite ^/(magazin|magazine)/category/unterhaltung-und-verschiedenes/escort-top-blogs/page/2/(.*)$ /community/v1Rewrite.php?id=12&$2 permanent;
    rewrite ^/(magazin|magazine)/category/unterhaltung-und-verschiedenes/beruehmte-huren/(.*)$ /community/v1Rewrite.php?id=13&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/page/3/(.*)$ /community/v1Rewrite.php?id=14&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/kunst-kultur/filme-ueber-prostitution/(.*)$ /community/v1Rewrite.php?id=15&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/escort-top-blogs/(.*)$ /community/v1Rewrite.php?id=16&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/adventskalender/page/3/(.*)$ /community/v1Rewrite.php?id=17&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/adventskalender/(.*)$ /community/v1Rewrite.php?id=18&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/interviews/escort-interviews/page/6/(.*)$ /community/v1Rewrite.php?id=19&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/interviews/escort-interviews/(.*)$ /community/v1Rewrite.php?id=20&$2 permanent;
    rewrite ^/(magazin|magazine)/home/der-sexy-kaufmich-adventskalender/(.*)$ /community/v1Rewrite.php?id=21&$2 permanent;
    rewrite ^/(magazin|magazine)/home/der-sexy-kaufmich-adventskalender-2/(.*)$ /community/v1Rewrite.php?id=22&$2 permanent;
    rewrite ^/(magazin|magazine)/kontakt/(.*)$ /community/v1Rewrite.php?id=23&$2 permanent;
    rewrite ^/(magazin|magazine)/teilnahmebedingungen-das-kaufmich-6666-dollar-facebook-posting/(.*)$ /community/v1Rewrite.php?id=24&$2 permanent;
    rewrite ^/(magazin|magazine)/umfragen-archiv/(.*)$ /community/v1Rewrite.php?id=25&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/aktuelles-national/(.*)$ /community/v1Rewrite.php?id=26&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/aktuelles-international/(.*)$ /community/v1Rewrite.php?id=27&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/kaufmich-events/(.*)$ /community/v1Rewrite.php?id=29&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/geburtstag/(.*)$ /community/v1Rewrite.php?id=30&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/gesundheit-sicherheit-politik-und-recht/safer-sex/(.*)$ /community/v1Rewrite.php?id=33&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/informationen-fuer-kunden-und-escorts/(.*)$ /community/v1Rewrite.php?id=35&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/lustiges/(.*)$ /community/v1Rewrite.php?id=36&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/escort-top-blogs/(.*)$ /community/v1Rewrite.php?id=37&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/von-unseren-gastautoren/(.*)$ /community/v1Rewrite.php?id=38&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/escort-blogs/(.*)$ /community/v1Rewrite.php?id=39&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/kunst-kultur/(.*)$ /community/v1Rewrite.php?id=40&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/lesestoff/(.*)$ /community/v1Rewrite.php?id=41&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/wie-funktioniert-kaufmich/(.*)$ /community/v1Rewrite.php?id=42&$2 permanent;
    rewrite ^/(magazin|magazine)/category/kaufmich/das-team/(.*)$ /community/v1Rewrite.php?id=43&$2 permanent;
    rewrite ^/(magazin|magazine)/aktuelles-international/laenderberichte-sexarbeit-in-der-ganzen-welt/(.*)$ /community/v1Rewrite.php?id=44&$2 permanent;
    rewrite ^/(community|magazine)/laenderberichte-sexarbeit-in-der-ganzen-welt/(.*)$ /community/v1Rewrite.php?id=45&$2 permanent;
    rewrite ^/(magazin|magazine)/prostituiertenschutzgesetz-2017/(.*)$ /community/v1Rewrite.php?id=46&$2 permanent;
    rewrite ^/(magazin|magazine)/informationsseite-zwangsprostitution/(.*)$ /community/v1Rewrite.php?id=47&$2 permanent;
    rewrite ^/(community|magazine)/informationsseite-zwangsprostitution/(.*)$ /community/v1Rewrite.php?id=48&$2 permanent;
    rewrite ^/(magazin|magazine)/kaufmich-und-safer-sex/(.*)$ /community/v1Rewrite.php?id=49&$2 permanent;
    rewrite ^/(community|magazine)/kaufmich-und-safer-sex/(.*)$ /community/v1Rewrite.php?id=50&$2 permanent;
    rewrite ^/(magazin|magazine)/home/info-guides-fuer-escorts/(.*)$ /community/v1Rewrite.php?id=51&$2 permanent;
    rewrite ^/(community|magazine)/info-guides-fuer-escorts/(.*)$ /community/v1Rewrite.php?id=52&$2 permanent;
    rewrite ^/(magazin|magazine)/das-grosse-kaufmich-sex-glossar-alles-ueber-sex/(.*)$ /community/v1Rewrite.php?id=53&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/das-kaufmich-glossar/(.*)$ /community/v1Rewrite.php?id=54&$2 permanent;
    rewrite ^/(community|magazine)/das-grosse-kaufmich-sex-glossar-alles-ueber-sex/(.*)$ /community/v1Rewrite.php?id=55&$2 permanent;
    rewrite ^/(magazin|magazine)/home/die-kaufmich-rotlicht-guides/(.*)$ /community/v1Rewrite.php?id=56&$2 permanent;
    rewrite ^/(community|magazine)/die-kaufmich-rotlicht-guides/(.*)$ /community/v1Rewrite.php?id=57&$2 permanent;
    rewrite ^/(magazin|magazine)/bdsm-glossar/(.*)$ /community/v1Rewrite.php?id=58&$2 permanent;
    rewrite ^/(community|magazine)/bdsm-glossar/(.*)$ /community/v1Rewrite.php?id=59&$2 permanent;
    rewrite ^/(magazin|magazine)/home/kmetiquette-die-regeln-fuer-kommentare-im-magazin/(.*)$ /community/v1Rewrite.php?id=60&$2 permanent;
    rewrite ^/(community|magazine)/kmetiquette-die-regeln-fuer-kommentare-im-magazin/(.*)$ /community/v1Rewrite.php?id=61&$2 permanent;
    rewrite ^/(magazin|magazine)/category/sexarbeit/beratungsstellen/(.*)$ /community/v1Rewrite.php?id=62&$2 permanent;
    rewrite ^/(community|magazine)/prostituiertenschutzgesetz-2017/(.*)$ /community/v1Rewrite.php?id=63&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/escort-interviews/(.*)$ /community/v1Rewrite.php?id=64&$2 permanent;
    rewrite ^/(magazin|magazine)/category/community/kunden-interviews/(.*)$ /community/v1Rewrite.php?id=65&$2 permanent;
    rewrite ^/(magazin|magazine)/category/(.*)$ /community/v1Rewrite.php?id=100&$2 permanent;

    rewrite ^/communityiframe$                /communityiframe/    permanent;
    rewrite ^/magazin/forum-rules/$           /communityiframe/forum-rules/    	permanent;
    rewrite ^/magazin/escort-only-rules/$     /communityiframe/escort-only-rules/    	permanent;
    rewrite ^/magazin/escorts-only-rules/$    /communityiframe/escorts-only-rules/    permanent;

    rewrite ^/communityiframe/magazin(.*)   /magazin$1  permanent;
    rewrite ^/communityiframe/magazine(.*)  /magazin$1  permanent;

    location ~* ^/(magazin|magazine)/.* {

        access_log /var/log/nginx/magazin-access.log;
        error_log /var/log/nginx/magazin-error.log error;

        if ($uri ~ (\.css|\.ico|\.jpg|\.jpeg|\.svg|\.gif|\.js|\.png|\.swf|\.rdf|\.htc|\.txt|\.mp3|\.ttf|\.woff|\.woff2|\.appcache|\.cur)$) {
            expires max;
            add_header Cache-Control public;
            rewrite ^/(magazin|magazine)(.*)$ $2 break;
        }
        root /var/www/forum;
        if ($request_uri ~ /(config|temp|logs|admin)/.*) {
            return 404;
        }

        rewrite ^/(magazin|magazine)/backend_dashboard(.*)$ @community/backend_dashboard/index.php last;

        rewrite ^/(magazin|magazine)/sitemap.xml$ @community/sitemap.php last;

        rewrite ^/(magazin|magazine)/$ @community/index.php last;
        rewrite ^/(magazin|magazine)/(.*\.php)$ @community/$2 last;
        rewrite ^/(magazin|magazine)(.*)$ @community/index.php last;

     }

    location ~* ^/communityiframe/.* {
        access_log /var/log/nginx/forum-access.log;
        error_log /var/log/nginx/forum-error.log error;
        root /var/www/forum;

        if ($uri ~ (\.css|\.ico|\.jpg|\.jpeg|\.gif|\.svg|\.js|\.png|\.swf|\.rdf|\.htc|\.txt|\.mp3|\.ttf|\.woff|\.woff2|\.appcache|\.cur|js\.php)$) {
           expires max;
           add_header Cache-Control public;
           rewrite ^/communityiframe(.*)$ $1 break;
        }

        rewrite ^/communityiframe/sitemap.xml$ @community/sitemap.php last;

        rewrite ^/communityiframe/$ @community/index.php last;
        rewrite ^/communityiframe/(.*\.php)$ @community/$1 last;
        rewrite ^/communityiframe/backend_dashboard(.*)$ @community/backend_dashboard/index.php last;
        rewrite ^/communityiframe(.*)$ @community/index.php last;
    }

    location ^~ @community {
        add_header cache-control private;
        add_header cache-control max-age=0;
        expires -1;

        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,Authorization,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-KM-FF,sentry-trace,baggage' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 86400;
        add_header 'Access-Control-Allow-Headers' 'Authorization';

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        root /var/www/forum;
        set $script $uri;
        set $path_info "";

        if ($uri ~ "@community(.+\.php)(.*)") {
            set $script $1;
            set $path_info $2;
        }

        include /etc/nginx/fastcgi_params;
        fastcgi_next_upstream off;
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $document_root$script;
        fastcgi_param SCRIPT_NAME $script;
        fastcgi_intercept_errors on;
        fastcgi_pass php-upstream;
    }
}